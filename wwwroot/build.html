<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV文件上传工具</title>
    <script src="./Static/js/vue.global.js"></script>
    <!-- element-plus -->
    <link rel="stylesheet" href="./Static/css/index.css">
    <script src="./Static/js/index.full.js"></script>
    <script src="./Static/js/Icons/index.iife.js"></script>
    <script src="./Static/js/zh-cn.js"></script>
    <script src="./Static/js/jquery.js"></script>
    <script src="./Static/js/echarts.js"></script>
    <script src="./Static/js/dayjs.min.js"></script>
    <link href="./Static/img/favicon32.ico" rel="shortcut icon" type="image/x-icon">
    <!-- clipboard -->
    <script src="./Static/js/clipboard.js"></script>

    <style>
        /* 全局样式：统一基调与间距 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
        }
        body {
            background-color: #f0f2f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        /* 主容器：居中卡片，增强层次感 */
        .upload-container {
            width: 100%;
            max-width: 600px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        /* 页面标题：突出主题 */
        .page-title {
            text-align: center;
            font-size: 22px;
            font-weight: 500;
            color: #1d5dcb;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .page-title el-icon {
            font-size: 24px;
        }
        /* 上传组件样式优化 */
        .custom-upload {
            height: 220px !important;
            border: 2px dashed #c0c4cc !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
            background-color: #fafbfc !important;
        }
        .custom-upload:hover {
            border-color: #1d5dcb !important;
            background-color: #f0f7ff !important;
        }
        /* 上传图标与文字：放大更醒目 */
        .el-upload__icon {
            font-size: 48px !important;
            color: #86909c !important;
        }
        .el-upload__text {
            font-size: 16px !important;
            color: #606266 !important;
            margin-top: 16px !important;
            line-height: 1.5 !important;
        }
        .el-upload__text em {
            color: #1d5dcb !important;
            font-weight: 500 !important;
            cursor: pointer;
        }
        /* 上传提示：突出限制条件 */
        .upload-tip {
            margin-top: 16px;
            font-size: 13px;
            color: #909399;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .upload-tip el-icon {
            color: #faad14 !important;
        }
        /* 上传进度条：居中显示 */
        .upload-progress {
            width: 80% !important;
            margin: 20px auto 0 !important;
        }
        /* 响应式适配：小屏幕调整间距 */
        @media (max-width: 768px) {
            .upload-container {
                padding: 20px;
            }
            .page-title {
                font-size: 18px;
            }
            .el-upload__icon {
                font-size: 40px !important;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 主卡片容器：居中显示 -->
        <div class="upload-container">
            <!-- 页面标题 -->
            <div class="page-title">
                <el-icon><file-upload-filled /></el-icon>
                CSV文件上传后编译为exe程序
            </div>

            <!-- CSV上传组件 -->
            <el-upload 
                class="custom-upload"
                drag 
                limit="1" 
                accept=".csv" 
                :on-success="uploadSuccess"
                :on-error="uploadError"
                :on-remove="handleFileRemove"
                :disabled="isUploading" 
                :before-upload="beforeUpload"
                :action="UrlPath.upload_url" 
                :multiple="false" 
                :file-list="uploadedFiles"
            >
                <!-- 上传默认状态 -->
                <template #default>
                    <el-icon class="el-upload__icon">
                        <upload-filled v-if="!isUploading" />
                        <loading v-else ></loading> <!-- 上传中显示加载图标 -->
                    </el-icon>
                    <div class="el-upload__text">
                        拖拽CSV文件到此处<br>或 <em>点击上传</em>
                    </div>
                </template>

                <!-- 上传中进度条 -->
                <template #uploading>
                    <el-progress 
                        class="upload-progress"
                        :percentage="uploadProgress" 
                        stroke-width="3" 
                        color="#1d5dcb"
                    />
                    <p style="text-align: center; margin-top: 12px; color: #606266; font-size: 14px;">
                        正在上传与处理（{{ uploadProgress }}%）...
                    </p>
                </template>

                <!-- 上传提示 -->
                <template #tip>
                    <div class="upload-tip">
                        <el-icon><warning-filled /></el-icon>
                        支持格式：.csv（单个文件最大20MB），请确保文件编码为UTF-8
                    </div>
                </template>

                <!-- 已上传文件显示 -->
                <template #file="{ file }">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px;">
                        <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 250px; color: #606266;">
                            {{ file.name }}
                        </span>
                        <el-button 
                            icon="delete" 
                            size="mini" 
                            type="text" 
                            @click.stop="handleFileRemove(file)"
                            style="color: #f56c6c;"
                        ></el-button>
                    </div>
                </template>
            </el-upload>
        </div>
    </div>
</body>
<script>
    // 基础URL配置：确保接口地址正确
    const UrlBase = (location.origin === "http://127.0.0.1:3000" ? "https://localhost:5001" : location.origin) + "/api";

    const { createApp, reactive, ref, toRaw } = Vue;

    const App = createApp({
        data() {
            return {
                UrlPath: {
                    GetAllFail: `${UrlBase}/FailReport/GetAllFail?Path=`,
                    GetLogDirectorys: `${UrlBase}/FailReport/GetLogDirectorys`,
                    GetFailData: `${UrlBase}/FailReport/GetFailData`,
                    OpenFileDirectory: `${UrlBase}/FailReport/OpenFileDirectory?Path=`,
                    SetLogsPath_Server: `${UrlBase}/FailReport/SetLogsPath?Path=`,
                    upload_url: `${UrlBase}/FailReport/UploadExcel/upload`, // 修复样式绑定错误，移除无用的:class绑定
                    DownloadPublishedFile: `${UrlBase}/FailReport/DownloadPublishedFile`,
                },
                uploadedFiles: [], // 已上传文件列表
                isUploading: false, // 上传状态
                uploadProgress: 0, // 上传进度（新增）
                allowedExts: ['csv'], // 允许的文件格式
            };
        },
        methods: {
            // 上传前校验：优化提示文案
            beforeUpload(file) {
                this.isUploading = true;
                this.uploadProgress = 0; // 重置进度
                const fileExt = file.name.split('.').pop().toLowerCase();

                // 1. 格式校验
                if (!this.allowedExts.includes(fileExt)) {
                    this.$message({
                        type: 'error',
                        message: '仅支持上传.csv格式的文件，请重新选择！',
                        icon: 'warning-filled'
                    });
                    this.isUploading = false;
                    return false;
                }

                // 2. 大小校验
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                if (fileSize > 20) {
                    this.$message({
                        type: 'error',
                        message: `文件大小超出限制（当前${fileSize}MB，最大支持20MB），请压缩文件后重试！`,
                        icon: 'warning-filled'
                    });
                    this.isUploading = false;
                    return false;
                }

                // 模拟上传进度（实际可根据接口实时返回进度调整）
                this.simulateUploadProgress();
                return true;
            },

            // 模拟上传进度：提升用户感知
            simulateUploadProgress() {
                const timer = setInterval(() => {
                    if (this.uploadProgress < 90) {
                        this.uploadProgress += Math.floor(Math.random() * 10);
                    } else {
                        clearInterval(timer);
                    }
                }, 300);
            },

            // 上传成功：优化弹窗与下载体验
            uploadSuccess(data) {
                this.uploadedFiles = []; // 清空文件列表
                this.uploadProgress = 100; // 进度置为100%
                const _this = this;
                const loading = ElementPlus.ElLoading.service({
                    lock: true,
                    text: '正在准备下载文件...',
                    background: 'rgba(0, 0, 0, 0.5)',
                });

                // 延迟弹窗：确保后台文件处理完成
                setTimeout(() => {
                    loading.close();
                    ElementPlus.ElMessageBox({
                        title: '上传成功！',
                        message: `
                            <div style="text-align: center; margin: 10px 0;">
                                文件已成功处理，可通过以下方式下载：
                            </div>
                            <div style="text-align: center; margin-top: 15px;">
                                <a href="${_this.UrlPath.DownloadPublishedFile}" style="color:#1d5dcb; text-decoration: underline; font-size: 14px;" target="_blank">
                                    点击下载文件
                                </a>
                            </div>
                        `,
                        type: 'success',
                        dangerouslyUseHTMLString: true,
                        confirmButtonText: '立即下载',
                        confirmButtonColor: '#1d5dcb',
                        cancelButtonText: '稍后下载'
                    }).then(() => {
                        // 点击确认按钮自动下载
                        this.handleDownload();
                        this.isUploading = false;
                    }).catch(() => {
                        this.isUploading = false;
                        this.$message.success('可在需要时手动访问下载链接');
                    });
                }, 1500);
            },

            // 上传失败：新增错误提示
            uploadError(err) {
                this.isUploading = false;
                this.uploadProgress = 0;
                this.$message({
                    type: 'error',
                    message: '文件上传失败，请检查网络或文件完整性后重试！',
                    icon: 'error-filled'
                });
                console.error('上传错误详情：', err);
            },

            // 移除已上传文件
            handleFileRemove(file) {
                this.uploadedFiles = this.uploadedFiles.filter(item => item.uid !== file.uid);
            },

            // 统一下载逻辑
            handleDownload() {
                const link = document.createElement('a');
                link.href = this.UrlPath.DownloadPublishedFile;
                link.download = `处理结果_${dayjs().format('YYYYMMDDHHmmss')}.csv`; // 自定义下载文件名
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            openFullScreen() {
                const loading = ElementPlus.ElLoading.service({
                    lock: true,
                    text: 'Loading',
                    background: 'rgba(0, 0, 0, 0.7)',
                });
                setTimeout(() => loading.close(), 200);
            },

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            filterMethod(query, item) {
                if (query) {
                    return toRaw(item.label).toLowerCase().includes(query.toLowerCase());
                }
                return item;
            }
        },
        mounted() {
            // 初始化时检查图标组件
            if (!window.ElementPlusIconsVue) {
                this.$message({
                    type: 'warning',
                    message: '图标组件加载失败，可能影响界面显示！',
                    icon: 'warning-filled'
                });
            }
        }
    });

    // 注册Element Plus图标
    if (typeof ElementPlusIconsVue !== 'undefined') {
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            App.component(key, component);
        }
    }

    // 全局注册Element Plus组件和消息提示
    App.config.globalProperties.$message = ElementPlus.ElMessage;
    App.use(ElementPlus, {
        locale: ElementPlusLocaleZhCn,
    }).mount('#app');
</script>
</html>